# Валидация платежных документов
В данной фиче, в разработку берется валидационный эндпоинт, на вход которого поступает директория, содержащая в себе платежные документы, которые планируется объединить в один документ. Провалидированные документы записываются в таблицу validation_file_history, а валидируемая директория записывается в таблицу validation_process общей базы данных проекта merge_xml_db.
## Структура БД
В этой задаче создается новый файл миграции баз данных для Liquibase, исходя из документации проекта:
![ERD](uml/ERD.png)
### Описание сущностей базы данных:
| Сущность                | Описание                                                                                           |
|-------------------------|----------------------------------------------------------------------------------------------------|
| validation_process      | Содержит информацию о каталоге с файлами платежей                                                  |
| validation_file_history | Содержит информацию о валидируемых файлах, а также о результатах валидации и об ошибках валидации. |

**validation_process**

| Атрибут                 | Тип данных | Описание                                                       | Ограничение     | Пример                              |
|-------------------------|------------|----------------------------------------------------------------|-----------------|-------------------------------------|
| validation_process_id   | uuid       | Уникальный идентификатор                                       | primary_key     | 71f5135e-fb46-415c-b4cf-bbb9be5692d |
| dir_ref                 | varchar    | Cсылка в windows проводнике на каталог с валидируемыми файлами | nullable: false | c:/Users/Ivanov/test/               |
| is_success              | boolean    | Прошел валидацию каталог или нет                               | nullable: false | true false                          |
| total_doc_ref           | varchar    | Ссылка на итоговый документ                                    | nullable: false | с:/Users/Ivanov/test/total          |
| validation_process_date | timestamp  | Дата завершения процесса валидации                             | nullable: false | 2023-11-14 15:02:38.550722          |

**validation_file_history**

| Атрибут               | Тип данных | Описание                                          | Ограничение     | Пример                              |
|-----------------------|------------|---------------------------------------------------|-----------------|-------------------------------------|
| validation_id         | uuid       | Уникальный идентификатор                          | primary_key     | 71f5135e-fb46-415c-b4cf-bbb9be5692d |
| validation_process_id | uuid       | Уникальный идентификатор                          | foreign_key     | 71f5135e-fb46-415c-b4cf-bbb9be5692d |
| file_name             | varchar    | Имя файла                                         | nullable: false |                                     |
| doc_ref               | varchar    | Ссылка в windows проводнике на  валидируемый файл | nullable: false | с:/Users/Ivanov/test/pay            |
| is_success            | boolean    | Прошел валидацию файл или нет                     | nullable: false | true false                          |
| fail_fields           | text       | Поля файла, которые не прошли валидацию           | nullable: true  |                                     |
| validation_date       | timestamp  | Дата завершения валидации файла                   | nullable: false | 2023-11-14 15:02:38.550722          |

## Пользовательский ввод
JSON файл, содержащий в себе директорию с платежными документами.

## Вывод пользователю
Если в результате валидации возникает ошибка, производится запись в базу данных о причине провала валидации, а пользователю выводится ошибка 400 "Не пройдена валидация" в JSON. Если валидация прошла успешна, так же производиться запись в базу данных и пользователю отправляется статус 200.

## Схема валидации
1) Система проверяет плательщика: он должен быть один во всех платежных документах. Если плательщики разные в поле fail_fields таблицы validation_file_history сохраняет сообщение: “Имя плательщика <Имя> отличается от имени представленного в предыдущем валидируемом файле <Имя>”;
2) Минимальная сумма платежа в документе должна быть больше или равна 10.00 рублям. Также система сохраняет соответствующее сообщение об ошибке в fail_fields, если сумма меньше 10.00 рублей: “Минимальная сумма платежа 10.00 руб.”;
3) Код валюты в платежном документе может быть только 810. Если код валюты не соответсвует этим требованиям, то в поле fail_fields сохраняется сообщение: "Код валюты <Код валюты> не поддерживается сервисом";
4) Дата платежа должна быть равна текущей дате.Также система сохраняет соответствующее сообщение об ошибке в fail_fields, если дата меньше или больше текущей: “Дата платежного документа должна быть равна текущей дате”;
5) Система должна автоматически устанавливать дату платежного документа (DOCUMENTDATE) равной текущей дате на момент создания нового платежного документа. Эта дата должна заполняться системой по умолчанию;
6) Система должна проверять, что введенный пользователем IP-адрес соответствует формату IPv4 и что каждое число в его составе находится в диапазоне от 0 до 255. В случае провала валидации, сохраняется сообщение: "Не валидный IP-адресс";
7) Параметры CODEREV, PAYTYPEPARAM, PAYGRNDPARAM должны соответствовать зависимостям указанным в таблице ниже. В случае не соответсвия сохраняется сообщение в fail_fields: "Не валидный параметр <Параметр>";

**Таблица соответствия показателей «тип платежа» в зависимости от «основания платежа»:**

| CODEREV, Код программ доходов бюджетов | PAYTYPEPARAM, тип платежа | PAYGRNDPARAM, основание платежа |
|----------------------------------------|---------------------------|---------------------------------|
| 1                                      | НС, АВ (ПЛ, ВЗ, ГП)       | ТП                              |
| 1                                      | НС                        | ЗД, ТР, АП, АР                  |
| 1                                      | НС                        | ОТ, РС, ПР, ВУ                  |
| 1                                      | НС                        | РТ                              |
| 2                                      | ПЕ                        | ЗД,ТР,ОТ,РС,РТ,ВУ,ПР,АП,АР      |
| 2                                      | ПЦ                        | РС, ОТ, РТ, ПР, ВУ              |
| 3                                      | СА, АШ, ИШ                | ЗД,ТР,РС,РТ,ВУ,ПР,АП,АР         |

**PAYGRNDPARAM, основание платежа:**

| Сокращение | Описание                                                                                                     |
|------------|--------------------------------------------------------------------------------------------------------------|
| ТП         | платеж текущего года без нарушения срока (текущий платеж)                                                    |
| ЗД         | добровольное погашение задолженности по истекшим налоговым периодам                                          |
| БФ         | текущие платежи физических лиц - клиентов банка (владельцев счета), уплачиваемые со своего банковского счета |
| ТР         | требование налогового органа                                                                                 |
| РС         | погашение рассроченной задолженности в соответствии с графиком рассрочки                                     |
| ОТ         | погашение отсроченной задолженности                                                                          |
| РТ         | погашение реструктурируемой задолженности                                                                    |
| ВУ         | погашение отсроченной задолженности в связи с введением внешнего управления                                  |
| ПР         | перечисление в счет погашения задолженности, приостановленной ко взысканию                                   |
| АП         | погашение задолженности по акту проверки                                                                     |
| АР         | погашение задолженности по исполнительному документу                                                         |

**PAYTYPEPARAM, тип платежа**

| Сокращение | Описание                                                                                   |
|------------|--------------------------------------------------------------------------------------------|
| НС         | уплата налога или сбора                                                                    |
| АВ         | уплата аванса или предоплата (в том числе декадные платежи)                                |
| ПЛ         | уплата платежа                                                                             |
| ГП         | уплата пошлины                                                                             |
| ВЗ         | уплата взноса                                                                              |
| ПЕ         | уплата пени                                                                                |
| ПЦ         | уплата процентов                                                                           |
| СА         | налоговые санкции, установленные Налоговым кодексом Российской Федерации                   |
| АШ         | административные штрафы                                                                    |
| ИШ         | иные штрафы, установленные соответствующими законодательными или иными нормативными актами |

8) Также, требуется осуществить проверку на повторную загрузку поступающих платежных документов уже объединенных в один документ. В случае обнаружения дубля в поле fail_fields сохраняется сообщение: "Данный платежный документ уже был объединен в общий документ".

## Что добавить
- Многопоточная валидация документов;
- Добавить таблицу с кодами валюты;